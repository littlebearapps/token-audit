name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Default permissions for all jobs (least privilege principle)
permissions:
  contents: read

jobs:
  # ============================================================================
  # Quality Gate (Python testing)
  # ============================================================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Install package in editable mode (with server extras)
        run: pip install -e ".[server]"

      - name: Validate version consistency
        # Skip if script doesn't exist (public repo excludes scripts/)
        if: hashFiles('scripts/validate-versions.py') != ''
        run: python scripts/validate-versions.py --verbose

      - name: Run tests with coverage
        run: pytest tests/ --cov=src/token_audit --cov-report=term-missing --cov-report=xml --cov-report=html

      - name: Type check with mypy
        run: mypy src/token_audit --config-file pyproject.toml

      - name: Lint with ruff
        run: ruff check .

      - name: Format check with black
        run: black --check .

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report
          path: |
            .coverage
            coverage.xml
            htmlcov/
          include-hidden-files: true  # Required for .coverage file

      # Upload to CodeCov for badge and tracking
      - name: Upload to CodeCov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          fail_ci_if_error: false
          verbose: true

      # GitHub-native coverage reporting with PR comments and annotations
      # No external service needed - badge stored in git branch
      # Note: continue-on-error handles large PRs (>20k lines) that exceed GitHub diff limits
      - name: Coverage analysis
        id: coverage
        continue-on-error: true
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          ANNOTATE_MISSING_LINES: true
          ANNOTATION_TYPE: warning

      # Store comment for fork PRs (two-workflow pattern)
      - name: Store coverage comment
        if: steps.coverage.outputs.COMMENT_FILE_WRITTEN == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: python-coverage-comment-action
          path: python-coverage-comment-action.txt

  # ============================================================================
  # Performance Benchmarks (v0.9.0 - task-107.3)
  # ============================================================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: quality-gate
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e ".[server]"

      - name: Run performance benchmarks
        run: |
          pytest tests/benchmarks/ -v -s 2>&1 | tee benchmark-output.txt

      - name: Check performance targets
        run: |
          pytest tests/benchmarks/ -v --tb=short

      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: benchmark-results
          path: benchmark-output.txt

  # ============================================================================
  # PR Review Summary (surfaces Codex and other review comments)
  # ============================================================================
  review-summary:
    name: PR Review Summary
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: read
    steps:
      - name: Fetch PR reviews and comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "## PR Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fetch reviews
          echo "### Reviews" >> $GITHUB_STEP_SUMMARY
          REVIEWS=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" \
            --jq '.[] | "- **\(.user.login)** (\(.state)): \(.body // "_No comment_")"' 2>/dev/null || echo "")
          if [ -z "$REVIEWS" ]; then
            echo "_No reviews yet_" >> $GITHUB_STEP_SUMMARY
          else
            echo "$REVIEWS" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Fetch inline comments
          echo "### Code Comments" >> $GITHUB_STEP_SUMMARY
          COMMENTS=$(gh api "repos/$REPO/pulls/$PR_NUMBER/comments" \
            --jq '.[] | "- **\(.user.login)** on `\(.path):\(.line // .original_line // "N/A")`: \(.body | split("\n")[0])"' 2>/dev/null || echo "")
          if [ -z "$COMMENTS" ]; then
            echo "_No inline comments_" >> $GITHUB_STEP_SUMMARY
          else
            echo "$COMMENTS" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Review summary generated at $(date -u +%Y-%m-%dT%H:%M:%SZ)_" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Codex Review Gate (blocks on P0/P1 findings)
  # ============================================================================
  codex-gate:
    name: Codex Review Gate
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: read
    steps:
      - name: Check for critical Codex findings
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Fetch Codex reviews (filter by bot username)
          CODEX_REVIEWS=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" \
            --jq '[.[] | select(.user.login == "chatgpt-codex-connector[bot]")]' 2>/dev/null || echo "[]")

          # Fetch Codex inline comments
          CODEX_COMMENTS=$(gh api "repos/$REPO/pulls/$PR_NUMBER/comments" \
            --jq '[.[] | select(.user.login == "chatgpt-codex-connector[bot]")]' 2>/dev/null || echo "[]")

          # Check for P0/P1 in review bodies
          P0_COUNT=$(echo "$CODEX_REVIEWS" | jq '[.[] | select(.body != null) | select(.body | test("\\[P0\\]"; "i"))] | length')
          P1_COUNT=$(echo "$CODEX_REVIEWS" | jq '[.[] | select(.body != null) | select(.body | test("\\[P1\\]"; "i"))] | length')

          # Check for P0/P1 in inline comments
          P0_INLINE=$(echo "$CODEX_COMMENTS" | jq '[.[] | select(.body != null) | select(.body | test("\\[P0\\]"; "i"))] | length')
          P1_INLINE=$(echo "$CODEX_COMMENTS" | jq '[.[] | select(.body != null) | select(.body | test("\\[P1\\]"; "i"))] | length')

          TOTAL_P0=$((P0_COUNT + P0_INLINE))
          TOTAL_P1=$((P1_COUNT + P1_INLINE))

          echo "Codex findings: P0=$TOTAL_P0, P1=$TOTAL_P1"

          if [ "$TOTAL_P0" -gt 0 ]; then
            echo "::error::Codex found $TOTAL_P0 P0 (critical) issues. Address before merging."
            echo "## Codex Review Gate: BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "Found **$TOTAL_P0 P0 (critical)** issues that must be addressed." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ "$TOTAL_P1" -gt 0 ]; then
            echo "::error::Codex found $TOTAL_P1 P1 (high priority) issues. Address before merging."
            echo "## Codex Review Gate: BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "Found **$TOTAL_P1 P1 (high priority)** issues that must be addressed." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "::notice::No critical Codex findings (P0/P1)"
          echo "## Codex Review Gate: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "No P0/P1 issues found." >> $GITHUB_STEP_SUMMARY
