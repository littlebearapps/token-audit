name: Publish mcp-audit Deprecation

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - name: Create deprecation package
        run: |
          mkdir -p src/mcp_audit
          
          cat > pyproject.toml << 'TOML'
          [build-system]
          requires = ["setuptools>=77.0.3", "wheel"]
          build-backend = "setuptools.build_meta"

          [project]
          name = "mcp-audit"
          version = "0.9.2"
          description = "DEPRECATED: This package has been renamed to token-audit."
          readme = "README.md"
          license = "MIT"
          requires-python = ">=3.10"
          dependencies = ["token-audit>=1.0.0"]

          [project.scripts]
          mcp-audit = "mcp_audit:main"

          [tool.setuptools]
          package-dir = {"" = "src"}
          packages = ["mcp_audit"]
          TOML
          
          cat > README.md << 'README'
          # mcp-audit (DEPRECATED)

          ⚠️ **This package has been renamed to token-audit.**

          ## Migration

          ```bash
          pip uninstall mcp-audit
          pip install token-audit
          ```

          See: https://github.com/littlebearapps/token-audit
          README
          
          cat > src/mcp_audit/__init__.py << 'PYTHON'
          import warnings
          warnings.warn("mcp-audit is deprecated. Install token-audit instead.", DeprecationWarning, stacklevel=2)
          from token_audit import *
          def main():
              print("\n⚠️  mcp-audit is deprecated. Use: pip install token-audit\n")
              from token_audit.cli import main as cli_main
              return cli_main()
          PYTHON

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build
        run: |
          pip install build
          python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
