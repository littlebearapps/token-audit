# token-audit v1.0.2 — MCP Server Enhancements

**Date**: December 26, 2025
**Type**: Patch Release (backward compatible)
**Branch**: `claude/token-audit-version-check-AAzau`

---

## Executive Summary

Gap analysis of v1.0.1 revealed that **CLI commands significantly outpace MCP server tool exposure**. While the CLI offers 11 commands with rich historical aggregation, session management, and drill-down capabilities, the MCP server exposes only 8 tools focused on live session tracking.

**Key Gap**: AI agents using MCP cannot query historical token usage (daily/weekly/monthly), browse sessions, or manage pinned servers — all features available via CLI.

This plan adds **7 new MCP tools** and **5 new MCP resources** to achieve feature parity for the most critical workflows.

**Note**: This release also establishes shared infrastructure (pagination, pinned server helpers) that v1.0.3 TUI will reuse.

---

## Problem Statement

### Current State (v1.0.1)

| Category | CLI Commands | MCP Tools | Gap |
|----------|-------------|-----------|-----|
| Live Tracking | `collect` | `start_tracking`, `get_metrics` | ✅ Parity |
| Session Analysis | `report` (3 modes) | `analyze_session`, `get_recommendations` | ✅ Parity |
| Historical Aggregation | `daily`, `weekly`, `monthly` | ❌ None | **CRITICAL** |
| Session Management | `sessions list/show/delete` | ❌ None | **HIGH** |
| Pinned Servers | `pin` (CRUD) | `get_pinned_servers` (read-only) | **MEDIUM** |
| Best Practices | `best-practices` | `get_best_practices` + 3 resources | ✅ Parity |
| Config Analysis | via `report` | `analyze_config` | ✅ Parity |
| Trends | via `report --smells` | `get_trends` | ✅ Parity |

### Impact

1. **AI agents cannot ask "What was my token usage this week?"** — The data exists but isn't exposed via MCP
2. **Drill-down workflows blocked** — Cannot go from trend detection to session investigation
3. **Historical analysis requires CLI fallback** — Breaks MCP-first agent workflows

---

## Proposed Solution

### New MCP Tools (7)

| Tool | Purpose | Priority |
|------|---------|----------|
| `get_daily_summary` | Daily token/cost aggregation | P0 |
| `get_weekly_summary` | Weekly token/cost aggregation | P0 |
| `get_monthly_summary` | Monthly token/cost aggregation | P0 |
| `list_sessions` | Query historical sessions | P1 |
| `get_session_details` | Retrieve full session data | P1 |
| `pin_server` | Add/update pinned server | P2 |
| `delete_session` | Remove session from storage | P2 |

### New MCP Resources (5)

| Resource URI | Purpose | Priority |
|--------------|---------|----------|
| `token-audit://usage/daily` | Daily aggregates (last 7 days) | P0 |
| `token-audit://usage/weekly` | Weekly aggregates (last 4 weeks) | P0 |
| `token-audit://usage/monthly` | Monthly aggregates (last 3 months) | P0 |
| `token-audit://sessions` | Session list (paginated) | P1 |
| `token-audit://sessions/{id}` | Session detail | P1 |

---

## Detailed Specifications

### Tool 1: `get_daily_summary`

**Purpose**: Retrieve daily token usage aggregation across sessions.

**Input Schema**:
```json
{
  "type": "object",
  "properties": {
    "days": {
      "type": "integer",
      "default": 7,
      "minimum": 1,
      "maximum": 90,
      "description": "Number of days to include (default: 7)"
    },
    "platform": {
      "type": "string",
      "enum": ["claude_code", "codex_cli", "gemini_cli", null],
      "description": "Filter by platform (null = all platforms)"
    },
    "project": {
      "type": "string",
      "description": "Filter by project name"
    },
    "breakdown": {
      "type": "boolean",
      "default": false,
      "description": "Include per-model token breakdown"
    }
  }
}
```

**Output Schema**:
```json
{
  "type": "object",
  "properties": {
    "period": {
      "type": "object",
      "properties": {
        "start": { "type": "string", "format": "date" },
        "end": { "type": "string", "format": "date" },
        "days": { "type": "integer" }
      }
    },
    "totals": {
      "type": "object",
      "properties": {
        "sessions": { "type": "integer" },
        "input_tokens": { "type": "integer" },
        "output_tokens": { "type": "integer" },
        "total_tokens": { "type": "integer" },
        "cost_usd": { "type": "number" }
      }
    },
    "daily": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "date": { "type": "string", "format": "date" },
          "sessions": { "type": "integer" },
          "input_tokens": { "type": "integer" },
          "output_tokens": { "type": "integer" },
          "total_tokens": { "type": "integer" },
          "cost_usd": { "type": "number" },
          "model_breakdown": {
            "type": "object",
            "additionalProperties": {
              "type": "object",
              "properties": {
                "input_tokens": { "type": "integer" },
                "output_tokens": { "type": "integer" },
                "cost_usd": { "type": "number" }
              }
            }
          }
        }
      }
    },
    "trends": {
      "type": "object",
      "properties": {
        "direction": { "type": "string", "enum": ["increasing", "decreasing", "stable"] },
        "change_percent": { "type": "number" },
        "busiest_day": { "type": "string", "format": "date" },
        "avg_daily_cost": { "type": "number" }
      }
    }
  }
}
```

**Implementation Notes**:
- Reuse `aggregate_daily()` from `src/token_audit/aggregation.py`
- Return empty `daily` array if no sessions found
- `model_breakdown` only included when `breakdown=true`

---

### Tool 2: `get_weekly_summary`

**Purpose**: Retrieve weekly token usage aggregation.

**Input Schema**:
```json
{
  "type": "object",
  "properties": {
    "weeks": {
      "type": "integer",
      "default": 4,
      "minimum": 1,
      "maximum": 52,
      "description": "Number of weeks to include (default: 4)"
    },
    "start_of_week": {
      "type": "string",
      "enum": ["monday", "sunday"],
      "default": "monday",
      "description": "Week boundary (Monday or Sunday)"
    },
    "platform": {
      "type": "string",
      "enum": ["claude_code", "codex_cli", "gemini_cli", null]
    },
    "breakdown": {
      "type": "boolean",
      "default": false
    }
  }
}
```

**Output Schema**:
```json
{
  "type": "object",
  "properties": {
    "period": {
      "type": "object",
      "properties": {
        "start": { "type": "string", "format": "date" },
        "end": { "type": "string", "format": "date" },
        "weeks": { "type": "integer" }
      }
    },
    "totals": {
      "type": "object",
      "properties": {
        "sessions": { "type": "integer" },
        "input_tokens": { "type": "integer" },
        "output_tokens": { "type": "integer" },
        "total_tokens": { "type": "integer" },
        "cost_usd": { "type": "number" }
      }
    },
    "weekly": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "week_start": { "type": "string", "format": "date" },
          "week_end": { "type": "string", "format": "date" },
          "sessions": { "type": "integer" },
          "input_tokens": { "type": "integer" },
          "output_tokens": { "type": "integer" },
          "total_tokens": { "type": "integer" },
          "cost_usd": { "type": "number" },
          "avg_session_cost": { "type": "number" },
          "model_breakdown": { "type": "object" }
        }
      }
    },
    "trends": {
      "type": "object",
      "properties": {
        "direction": { "type": "string" },
        "change_percent": { "type": "number" },
        "busiest_week": { "type": "string", "format": "date" }
      }
    }
  }
}
```

**Implementation Notes**:
- Reuse `aggregate_weekly()` from `src/token_audit/aggregation.py`
- Week boundaries respect `start_of_week` parameter
- Include week-over-week trend calculation

---

### Tool 3: `get_monthly_summary`

**Purpose**: Retrieve monthly token usage aggregation.

**Input Schema**:
```json
{
  "type": "object",
  "properties": {
    "months": {
      "type": "integer",
      "default": 3,
      "minimum": 1,
      "maximum": 24,
      "description": "Number of months to include (default: 3)"
    },
    "platform": {
      "type": "string",
      "enum": ["claude_code", "codex_cli", "gemini_cli", null]
    },
    "breakdown": {
      "type": "boolean",
      "default": false
    }
  }
}
```

**Output Schema**:
```json
{
  "type": "object",
  "properties": {
    "period": {
      "type": "object",
      "properties": {
        "start": { "type": "string", "format": "date" },
        "end": { "type": "string", "format": "date" },
        "months": { "type": "integer" }
      }
    },
    "totals": { "type": "object" },
    "monthly": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "month": { "type": "string", "pattern": "^\\d{4}-\\d{2}$" },
          "sessions": { "type": "integer" },
          "input_tokens": { "type": "integer" },
          "output_tokens": { "type": "integer" },
          "total_tokens": { "type": "integer" },
          "cost_usd": { "type": "number" },
          "model_breakdown": { "type": "object" }
        }
      }
    },
    "trends": {
      "type": "object",
      "properties": {
        "direction": { "type": "string" },
        "change_percent": { "type": "number" },
        "busiest_month": { "type": "string" }
      }
    }
  }
}
```

**Implementation Notes**:
- Reuse `aggregate_monthly()` from `src/token_audit/aggregation.py`
- Month format: `YYYY-MM`

---

### Tool 4: `list_sessions`

**Purpose**: Query and list historical sessions with filtering.

**Input Schema**:
```json
{
  "type": "object",
  "properties": {
    "limit": {
      "type": "integer",
      "default": 20,
      "minimum": 1,
      "maximum": 100,
      "description": "Maximum sessions to return"
    },
    "offset": {
      "type": "integer",
      "default": 0,
      "description": "Pagination offset"
    },
    "platform": {
      "type": "string",
      "enum": ["claude_code", "codex_cli", "gemini_cli", null]
    },
    "project": {
      "type": "string",
      "description": "Filter by project name"
    },
    "since": {
      "type": "string",
      "format": "date",
      "description": "Only sessions after this date"
    },
    "until": {
      "type": "string",
      "format": "date",
      "description": "Only sessions before this date"
    },
    "sort_by": {
      "type": "string",
      "enum": ["date", "cost", "tokens", "duration"],
      "default": "date"
    },
    "sort_order": {
      "type": "string",
      "enum": ["asc", "desc"],
      "default": "desc"
    }
  }
}
```

**Output Schema**:
```json
{
  "type": "object",
  "properties": {
    "sessions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "platform": { "type": "string" },
          "project": { "type": "string" },
          "started_at": { "type": "string", "format": "date-time" },
          "ended_at": { "type": "string", "format": "date-time" },
          "duration_seconds": { "type": "integer" },
          "total_tokens": { "type": "integer" },
          "cost_usd": { "type": "number" },
          "model": { "type": "string" },
          "tool_calls": { "type": "integer" },
          "smells_detected": { "type": "integer" },
          "data_quality": { "type": "string", "enum": ["exact", "estimated", "calls-only"] }
        }
      }
    },
    "pagination": {
      "type": "object",
      "properties": {
        "total": { "type": "integer" },
        "limit": { "type": "integer" },
        "offset": { "type": "integer" },
        "has_more": { "type": "boolean" }
      }
    }
  }
}
```

**Implementation Notes**:
- Leverage `StorageManager.list_sessions()` with filtering
- Use header peeking for performance (avoid full JSON parse)
- Respect pagination limits for memory efficiency

---

### Tool 5: `get_session_details`

**Purpose**: Retrieve complete session data including tool calls and smells.

**Input Schema**:
```json
{
  "type": "object",
  "required": ["session_id"],
  "properties": {
    "session_id": {
      "type": "string",
      "description": "Session ID to retrieve"
    },
    "include_tool_calls": {
      "type": "boolean",
      "default": true,
      "description": "Include individual tool call details"
    },
    "include_smells": {
      "type": "boolean",
      "default": true,
      "description": "Include detected efficiency smells"
    },
    "include_recommendations": {
      "type": "boolean",
      "default": true,
      "description": "Include optimization recommendations"
    }
  }
}
```

**Output Schema**:
```json
{
  "type": "object",
  "properties": {
    "session": {
      "type": "object",
      "properties": {
        "session_id": { "type": "string" },
        "platform": { "type": "string" },
        "project": { "type": "string" },
        "started_at": { "type": "string", "format": "date-time" },
        "ended_at": { "type": "string", "format": "date-time" },
        "duration_seconds": { "type": "integer" },
        "model": { "type": "string" },
        "models_used": { "type": "array", "items": { "type": "string" } }
      }
    },
    "token_usage": {
      "type": "object",
      "properties": {
        "input_tokens": { "type": "integer" },
        "output_tokens": { "type": "integer" },
        "cache_read_tokens": { "type": "integer" },
        "cache_write_tokens": { "type": "integer" },
        "reasoning_tokens": { "type": "integer" },
        "total_tokens": { "type": "integer" },
        "cost_usd": { "type": "number" }
      }
    },
    "mcp_usage": {
      "type": "object",
      "properties": {
        "servers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "tools_used": { "type": "integer" },
              "total_calls": { "type": "integer" },
              "total_tokens": { "type": "integer" }
            }
          }
        },
        "top_tools": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "calls": { "type": "integer" },
              "tokens": { "type": "integer" },
              "avg_tokens": { "type": "number" }
            }
          }
        }
      }
    },
    "tool_calls": {
      "type": "array",
      "description": "Only if include_tool_calls=true",
      "items": {
        "type": "object",
        "properties": {
          "timestamp": { "type": "string", "format": "date-time" },
          "tool_name": { "type": "string" },
          "server": { "type": "string" },
          "tokens_in": { "type": "integer" },
          "tokens_out": { "type": "integer" },
          "is_estimated": { "type": "boolean" }
        }
      }
    },
    "smells": {
      "type": "array",
      "description": "Only if include_smells=true",
      "items": {
        "type": "object",
        "properties": {
          "pattern": { "type": "string" },
          "severity": { "type": "string" },
          "message": { "type": "string" },
          "evidence": { "type": "object" }
        }
      }
    },
    "recommendations": {
      "type": "array",
      "description": "Only if include_recommendations=true"
    },
    "data_quality": {
      "type": "object",
      "properties": {
        "accuracy_level": { "type": "string" },
        "pricing_source": { "type": "string" },
        "confidence": { "type": "number" }
      }
    }
  }
}
```

**Implementation Notes**:
- Load session from storage via `StorageManager.load_session()`
- Optionally filter out large arrays based on `include_*` flags
- Generate recommendations on-the-fly if not stored

---

### Tool 6: `pin_server`

**Purpose**: Add or update a pinned MCP server.

**Input Schema**:
```json
{
  "type": "object",
  "required": ["server_name"],
  "properties": {
    "server_name": {
      "type": "string",
      "description": "MCP server name to pin"
    },
    "notes": {
      "type": "string",
      "description": "Optional notes about why this server is pinned"
    },
    "action": {
      "type": "string",
      "enum": ["pin", "unpin"],
      "default": "pin",
      "description": "Pin or unpin the server"
    }
  }
}
```

**Output Schema**:
```json
{
  "type": "object",
  "properties": {
    "success": { "type": "boolean" },
    "action": { "type": "string" },
    "server_name": { "type": "string" },
    "message": { "type": "string" },
    "pinned_servers": {
      "type": "array",
      "description": "Updated list of all pinned servers"
    }
  }
}
```

**Implementation Notes**:
- Modify `~/.token-audit/pinned-servers.json`
- Validate server name format
- Return updated pinned server list after modification

---

### Tool 7: `delete_session`

**Purpose**: Delete a session from storage.

**Input Schema**:
```json
{
  "type": "object",
  "required": ["session_id"],
  "properties": {
    "session_id": {
      "type": "string",
      "description": "Session ID to delete"
    },
    "confirm": {
      "type": "boolean",
      "default": false,
      "description": "Must be true to confirm deletion (safety check)"
    }
  }
}
```

**Output Schema**:
```json
{
  "type": "object",
  "properties": {
    "success": { "type": "boolean" },
    "session_id": { "type": "string" },
    "message": { "type": "string" },
    "deleted_at": { "type": "string", "format": "date-time" }
  }
}
```

**Implementation Notes**:
- Require `confirm=true` as safety check (prevents accidental deletion)
- Return error if session not found
- Delete both session JSON and any associated JSONL files
- Log deletion for audit trail

---

## MCP Resources

### Resource 1: `token-audit://usage/daily`

**Purpose**: Quick access to last 7 days of usage data.

**Format**: JSON matching `get_daily_summary` output with `days=7`

**Use Case**: Dashboard widgets, quick status checks

---

### Resource 2: `token-audit://usage/weekly`

**Purpose**: Last 4 weeks of usage data.

**Format**: JSON matching `get_weekly_summary` output with `weeks=4`

---

### Resource 3: `token-audit://usage/monthly`

**Purpose**: Last 3 months of usage data.

**Format**: JSON matching `get_monthly_summary` output with `months=3`

---

### Resource 4: `token-audit://sessions`

**Purpose**: Paginated session list (most recent 20).

**Format**: JSON matching `list_sessions` output with defaults

---

### Resource 5: `token-audit://sessions/{session_id}`

**Purpose**: Full session details.

**Format**: JSON matching `get_session_details` output with all includes enabled

---

## Pre-requisite: Fix Index File Concurrency

**Priority**: P0 — Must fix before adding more concurrent operations

### Current Issue

Index files (`~/.token-audit/sessions/**/.index.json`) have **no file locking**. If MCP server and CLI/TUI both update indexes simultaneously, data can be lost.

### Required Fix

Add file locking to `storage.py`:

```python
def save_daily_index(self, index: DailyIndex) -> None:
    """Save daily index with file locking."""
    index_path = self._get_daily_index_path(index.date)
    lock_path = index_path.with_suffix('.lock')

    with FileLock(lock_path):
        # Read-modify-write under lock
        temp_path = index_path.with_suffix('.tmp')
        with open(temp_path, 'w') as f:
            json.dump(index.to_dict(), f, indent=2)
        temp_path.rename(index_path)  # Atomic on POSIX

def save_platform_index(self, index: PlatformIndex) -> None:
    """Save platform index with file locking."""
    # Same pattern as above
```

### Files to Modify

- `src/token_audit/storage.py`:
  - `save_daily_index()` — Add file locking
  - `save_platform_index()` — Add file locking
  - `update_indexes_for_session()` — Hold lock during read-modify-write

### Estimated Effort

1 day (can be done in Phase 1)

---

## Shared Infrastructure (for v1.0.3 TUI reuse)

This release creates shared helpers that v1.0.3 TUI will reuse, ensuring consistency and avoiding code duplication.

### `storage.py` Additions

```python
def list_sessions_paginated(
    limit: int = 20,
    offset: int = 0,
    platform: str | None = None,
    project: str | None = None,
    since: datetime | None = None,
    until: datetime | None = None,
    sort_by: str = "date",  # date, cost, tokens, duration
    sort_order: str = "desc",  # asc, desc
) -> tuple[list[SessionIndex], int]:
    """
    List sessions with pagination and filtering.

    Returns:
        Tuple of (sessions, total_count) for pagination metadata.
    """

def delete_session(session_id: str) -> bool:
    """
    Delete a session and its associated files.

    Returns:
        True if deleted, False if not found.
    """
```

### `preferences.py` Additions

```python
def add_pinned_server(
    server_name: str,
    notes: str | None = None,
    method: str = "manual"
) -> PinnedServer:
    """Add a server to pinned list. Returns the created PinnedServer."""

def remove_pinned_server(server_name: str) -> bool:
    """Remove a server from pinned list. Returns True if found and removed."""

def update_pinned_server(
    server_name: str,
    notes: str | None = None
) -> PinnedServer | None:
    """Update notes for a pinned server. Returns updated server or None if not found."""
```

### Concurrency Considerations

Both MCP server and TUI may run simultaneously. Shared infrastructure must handle:

1. **File locking**: Use `fcntl.flock()` or `filelock` library for writes to:
   - `~/.token-audit/pinned-servers.json`
   - `~/.token-audit/preferences.json`
   - Session files during deletion

2. **Read consistency**: Use atomic writes (write to temp file, then rename)

3. **Cache invalidation**: TUI should detect external changes and refresh

See "Concurrency Safety" section below for detailed requirements.

---

## Implementation Plan

### Phase 1: Historical Aggregation Tools (P0)

**Files to Modify**:
- `src/token_audit/server/tools.py` — Add 3 new tool handlers
- `src/token_audit/server/main.py` — Register tools and resources

**Steps**:

1. **Add `get_daily_summary` tool**
   - Import `aggregate_daily` from `aggregation.py`
   - Create input validation with pydantic or manual checks
   - Wrap aggregation output in MCP tool response format
   - Add to tool registry in `main.py`

2. **Add `get_weekly_summary` tool**
   - Same pattern as daily
   - Handle `start_of_week` parameter

3. **Add `get_monthly_summary` tool**
   - Same pattern as daily/weekly

4. **Add MCP resources for usage data**
   - Create resource handlers in `main.py`
   - Register URIs: `token-audit://usage/daily`, `weekly`, `monthly`

5. **Tests**
   - Add tests in `tests/test_server_aggregation.py`
   - Test edge cases: no data, single day, platform filters

**Estimated Effort**: 2-3 days

---

### Phase 2: Session Management Tools (P1)

**Files to Modify**:
- `src/token_audit/server/tools.py` — Add 2 new tool handlers
- `src/token_audit/storage.py` — May need pagination helpers

**Steps**:

1. **Add `list_sessions` tool**
   - Leverage existing `StorageManager.list_sessions()`
   - Add pagination logic (offset/limit)
   - Add sorting support
   - Use header peeking for performance

2. **Add `get_session_details` tool**
   - Load full session via `StorageManager.load_session()`
   - Apply include flags to filter response size
   - Generate recommendations if not stored

3. **Add MCP resources**
   - `token-audit://sessions` — List view
   - `token-audit://sessions/{id}` — Detail view (dynamic)

4. **Tests**
   - Add tests in `tests/test_server_sessions.py`
   - Test pagination, filtering, sorting
   - Test session not found error handling

**Estimated Effort**: 2-3 days

---

### Phase 3: Pinned Server & Session Management (P2)

**Files to Modify**:
- `src/token_audit/server/tools.py` — Add 2 new tool handlers
- `src/token_audit/preferences.py` — Add pinned server write helpers
- `src/token_audit/storage.py` — Add delete_session helper

**Steps**:

1. **Add shared infrastructure helpers**
   - `preferences.py`: `add_pinned_server()`, `remove_pinned_server()`, `update_pinned_server()`
   - `storage.py`: `delete_session()`
   - Add file locking for concurrent access safety

2. **Add `pin_server` tool**
   - Use shared `add_pinned_server()` / `remove_pinned_server()` helpers
   - Return confirmation with updated list

3. **Add `delete_session` tool**
   - Use shared `delete_session()` helper
   - Require `confirm=true` safety check
   - Return success/failure with message

4. **Tests**
   - Test pin/unpin flow
   - Test delete with and without confirm flag
   - Test concurrent access (MCP + TUI simulation)

**Estimated Effort**: 2 days

---

## Testing Strategy

### Unit Tests

| Test File | Coverage |
|-----------|----------|
| `tests/test_server_aggregation.py` | Daily/weekly/monthly tools |
| `tests/test_server_sessions.py` | list_sessions, get_session_details |
| `tests/test_server_pinned.py` | pin_server tool |

### Integration Tests

- MCP client → server round-trip for each new tool
- Resource URI resolution
- Error handling (session not found, invalid params)

### Performance Benchmarks

| Operation | Target |
|-----------|--------|
| `get_daily_summary(7)` | <100ms |
| `get_weekly_summary(4)` | <100ms |
| `get_monthly_summary(3)` | <100ms |
| `list_sessions(20)` | <200ms |
| `get_session_details` | <500ms |

---

## Documentation Updates

### Files to Update

| File | Changes |
|------|---------|
| `docs/mcp-server-guide.md` | Add 6 new tools, 5 new resources |
| `docs/API.md` | Document new tool schemas |
| `CHANGELOG.md` | v1.0.2 release notes |
| `README.md` | Update MCP tool count (8 → 14 tools) |

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Aggregation performance | Low | Medium | Reuse optimized CLI code |
| Storage lock contention | Low | Low | Read-only operations for most tools |
| Schema changes | Low | High | All outputs are additive; no breaking changes |
| Test coverage gaps | Medium | Medium | Require 80%+ coverage before merge |

---

## Success Criteria

1. **All 7 tools passing CI tests**
2. **All 5 resources accessible via MCP protocol**
3. **Performance benchmarks met**
4. **Shared infrastructure helpers implemented and tested**
5. **Concurrent access safety verified (MCP + TUI)**
6. **Documentation updated**
7. **No breaking changes to existing 8 tools**

---

## Timeline

| Phase | Scope | Estimate |
|-------|-------|----------|
| Phase 1 | Aggregation tools (3) + resources (3) | 2-3 days |
| Phase 2 | Session tools (2) + resources (2) | 2-3 days |
| Phase 3 | Pinned server (1) + delete (1) + shared infra | 2 days |
| Testing & Docs | Full coverage + concurrency tests | 1-2 days |
| **Total** | | **7-10 days** |

---

## Appendix: Existing Code to Reuse

### `src/token_audit/aggregation.py` (923 lines)

Functions available:
- `aggregate_daily(sessions, days)` → `DailyAggregate`
- `aggregate_weekly(sessions, weeks, start_of_week)` → `WeeklyAggregate`
- `aggregate_monthly(sessions, months)` → `MonthlyAggregate`

### `src/token_audit/storage.py`

Functions available:
- `StorageManager.list_sessions(platform, project, since, until)` → `List[SessionIndex]`
- `StorageManager.load_session(session_id)` → `Session`
- `StorageManager.peek_session_header(path)` → `Dict` (fast metadata)

### `src/token_audit/preferences.py`

Functions available:
- `load_pinned_servers()` → `List[PinnedServer]`
- `save_pinned_servers(servers)` → `None`

---

## Concurrency Safety

### Scenario: MCP Server + TUI Running Simultaneously

A user may have:
1. `token-audit ui` open in one terminal (TUI)
2. An AI agent using the MCP server in another session

Both may attempt concurrent operations on shared resources.

### Shared Resources

| Resource | Location | Read By | Written By |
|----------|----------|---------|------------|
| Session files | `~/.token-audit/sessions/` | Both | MCP (delete), TUI (delete) |
| Pinned servers | `~/.token-audit/pinned-servers.json` | Both | Both |
| Preferences | `~/.token-audit/preferences.json` | Both | TUI only |
| Active sessions | `~/.token-audit/active/` | Both | Both (live tracking) |

### Concurrency Strategies

#### 1. File Locking for Writes

Use `filelock` library for cross-process file locking:

```python
from filelock import FileLock

def save_pinned_servers(servers: list[PinnedServer]) -> None:
    path = get_pinned_servers_path()
    lock = FileLock(f"{path}.lock")

    with lock:
        # Write to temp file first
        temp_path = path.with_suffix('.tmp')
        temp_path.write_text(json.dumps([s.to_dict() for s in servers]))
        # Atomic rename
        temp_path.rename(path)
```

#### 2. Atomic Writes

All file writes use the pattern:
1. Write to temporary file (same directory)
2. `os.rename()` to final path (atomic on POSIX)

This prevents partial reads of incomplete files.

#### 3. Read-After-Write Consistency

For MCP tools that modify and return data:
1. Acquire lock
2. Read current state
3. Modify
4. Write (atomic)
5. Release lock
6. Return updated state

#### 4. TUI Cache Invalidation

TUI should detect external changes:

```python
class BrowserState:
    def __init__(self):
        self._pinned_servers_mtime: float | None = None

    def refresh_if_stale(self) -> bool:
        """Check if pinned servers file changed externally."""
        path = get_pinned_servers_path()
        current_mtime = path.stat().st_mtime
        if current_mtime != self._pinned_servers_mtime:
            self._reload_pinned_servers()
            self._pinned_servers_mtime = current_mtime
            return True
        return False
```

#### 5. Delete Safety

When deleting sessions:
1. Check session exists
2. Acquire lock on session file
3. Delete file
4. Release lock
5. Invalidate any caches

If TUI has session open while MCP deletes it:
- TUI should handle "file not found" gracefully
- Show "Session was deleted" notification

### Testing Concurrent Access

Add integration tests that simulate:
1. MCP `pin_server` while TUI Pinned Servers view is open
2. MCP `delete_session` while TUI has session selected
3. Both MCP and TUI attempting to pin same server simultaneously
4. TUI refresh detecting MCP-made changes

### Dependencies

Add to `pyproject.toml`:
```toml
[project.optional-dependencies]
server = [
    ...
    "filelock>=3.12.0",  # Cross-process file locking
]
```

---

**Last Updated**: December 26, 2025
