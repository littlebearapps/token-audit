# Token Audit AI Export Schema

**Version**: 1.2.0
**Last Updated**: 2025-12-14
**Status**: Active (enhanced in v1.0.0)

This document defines the AI-ready export format generated by `[A] Ask AI` in the TUI or `token-audit report --format ai` CLI command.

---

## Overview

The AI export system generates:

1. **Structured JSON summary** - Compact telemetry data optimized for AI consumption
2. **Templated prompt** - Instructions for AI CLI agents (Claude, Codex, Gemini)

The AI CLI agent becomes the analytical layer. Token Audit provides facts; AI provides interpretation.

---

## Export Commands

### CLI

```bash
# Single session
token-audit report --format ai --session <id>

# Multiple sessions (comparison)
token-audit report --format ai --sessions <id1> <id2> <id3>

# Save to file
token-audit report --format ai --session <id> --output analysis-request.md
```

### TUI Keybinding

```
[A] Ask AI
```

Works in both Live Overview and Session Browser modes.

---

## Output Format

### Markdown Wrapper

Output is wrapped in markdown for easy copy-paste:

````markdown
# Token Audit - AI Analysis Request

Paste the following into your AI CLI agent (Claude, Gemini, Codex, etc.)

## Instructions for AI

[PROMPT TEMPLATE HERE]

## Session Telemetry

```json
[SUMMARY JSON HERE]
```
````

---

## Single Session Summary Schema

Compact format for analyzing one session:

```json
{
  "_export": {
    "type": "token_audit_ai_summary",
    "version": "1.0.0",
    "generated_at": "2025-12-07T14:45:00+11:00",
    "sessions_included": 1
  },
  "project": "zen-mcp",
  "platform": "claude-code",
  "model": "claude-opus-4-5-20251101",
  "session_id": "zen-mcp-2025-12-07T14-32-05",
  "data_quality": "exact",
  "started_at": "2025-12-07T14:32:05+11:00",
  "duration_seconds": 770,
  "total_tokens": 342110,
  "cost_usd": 1.23,
  "mcp_share": 0.72,
  "cache_savings_usd": 1.22,
  "smell_count": 3,
  "servers": [
    {
      "name": "zen",
      "tokens": 156000,
      "calls": 8,
      "tools": [
        {
          "name": "thinkdeep",
          "tokens": 144000,
          "calls": 5,
          "avg_tokens": 28800,
          "p95": 37519,
          "median": 11202,
          "smells": ["HIGH_VARIANCE", "TOP_CONSUMER"]
        },
        {
          "name": "chat",
          "tokens": 12000,
          "calls": 3,
          "avg_tokens": 4000,
          "smells": []
        }
      ]
    },
    {
      "name": "brave-search",
      "tokens": 89000,
      "calls": 14,
      "tools": [
        {
          "name": "brave_web_search",
          "tokens": 89000,
          "calls": 14,
          "avg_tokens": 6357,
          "smells": ["CHATTY"]
        }
      ]
    }
  ],
  "smells": [
    {"id": "HIGH_VARIANCE", "tool": "zen:thinkdeep", "p95": 37519, "median": 11202},
    {"id": "TOP_CONSUMER", "tool": "zen:thinkdeep", "share": 0.46},
    {"id": "CHATTY", "tool": "brave-search:brave_web_search", "calls": 14}
  ]
}
```

### Field Descriptions

#### `_export` Header

| Field | Type | Description |
|-------|------|-------------|
| `type` | string | Always `"token_audit_ai_summary"` or `"token_audit_ai_comparison"` |
| `version` | string | Export schema version |
| `generated_at` | string | ISO 8601 timestamp |
| `sessions_included` | int | Number of sessions in export |

#### Session Fields

| Field | Type | Description |
|-------|------|-------------|
| `project` | string | Project name |
| `platform` | string | `"claude-code"`, `"codex-cli"`, or `"gemini-cli"` |
| `model` | string | AI model identifier |
| `session_id` | string | Unique session ID |
| `data_quality` | string | `"exact"`, `"~N%"` (estimated), or `"calls"` |
| `started_at` | string | Session start (ISO 8601) |
| `duration_seconds` | int | Session duration |
| `total_tokens` | int | Total tokens consumed |
| `cost_usd` | float | Estimated cost in USD |
| `mcp_share` | float | MCP tokens as fraction of total (0.0-1.0) |
| `cache_savings_usd` | float | Cache savings in USD |
| `smell_count` | int | Total number of smells detected |

#### Server/Tool Hierarchy

| Field | Type | Description |
|-------|------|-------------|
| `servers[].name` | string | MCP server name |
| `servers[].tokens` | int | Total tokens for server |
| `servers[].calls` | int | Total calls to server |
| `servers[].tools[].name` | string | Tool name (without server prefix) |
| `servers[].tools[].tokens` | int | Total tokens for tool |
| `servers[].tools[].calls` | int | Number of calls |
| `servers[].tools[].avg_tokens` | int | Average tokens per call |
| `servers[].tools[].p95` | int | 95th percentile tokens (if available) |
| `servers[].tools[].median` | int | Median tokens (if available) |
| `servers[].tools[].smells` | array | Smell IDs affecting this tool |

#### Top-Level Smells

| Field | Type | Description |
|-------|------|-------------|
| `smells[].id` | string | Smell type |
| `smells[].tool` | string | Affected tool (`server:tool` format) |
| (varies) | varies | Smell-specific fields |

---

## Multi-Session Comparison Schema

Compact format for comparing multiple sessions:

```json
{
  "_export": {
    "type": "token_audit_ai_comparison",
    "version": "1.0.0",
    "generated_at": "2025-12-07T14:45:00+11:00",
    "sessions_included": 2
  },
  "sessions": [
    {
      "session_id": "zen-mcp-2025-12-07T14-32-05",
      "project": "zen-mcp",
      "platform": "claude-code",
      "data_quality": "exact",
      "started_at": "2025-12-07T14:32:05+11:00",
      "duration_seconds": 770,
      "total_tokens": 342110,
      "cost_usd": 1.23,
      "mcp_share": 0.72,
      "smell_count": 3,
      "servers": [
        {
          "name": "zen",
          "tokens": 156000,
          "calls": 8,
          "tools": [...]
        }
      ]
    },
    {
      "session_id": "token-audit-2025-12-06T16-42-00",
      "project": "token-audit",
      "platform": "codex-cli",
      "data_quality": "~6%",
      "started_at": "2025-12-06T16:42:00+11:00",
      "duration_seconds": 1200,
      "total_tokens": 189000,
      "cost_usd": 0.67,
      "mcp_share": 0.58,
      "smell_count": 0,
      "servers": [...]
    }
  ],
  "deltas": {
    "total_tokens_diff": 153110,
    "cost_diff_usd": 0.56,
    "mcp_share_diff": 0.14,
    "smell_count_diff": 3
  },
  "cross_session_observations": {
    "most_expensive_session": "zen-mcp-2025-12-07T14-32-05",
    "highest_mcp_share": "zen-mcp-2025-12-07T14-32-05",
    "common_servers": ["zen"],
    "unique_to_first": ["brave-search"],
    "unique_to_others": ["backlog"]
  }
}
```

### Comparison-Specific Fields

#### `deltas` Block

Pre-computed differences between sessions:

| Field | Type | Description |
|-------|------|-------------|
| `total_tokens_diff` | int | Difference in total tokens (first - last) |
| `cost_diff_usd` | float | Difference in cost |
| `mcp_share_diff` | float | Difference in MCP share |
| `smell_count_diff` | int | Difference in smell count |

#### `cross_session_observations` Block

Structural observations for AI analysis:

| Field | Type | Description |
|-------|------|-------------|
| `most_expensive_session` | string | Session ID with highest cost |
| `highest_mcp_share` | string | Session ID with highest MCP share |
| `common_servers` | array | Servers used in all sessions |
| `unique_to_first` | array | Servers only in first session |
| `unique_to_others` | array | Servers only in other sessions |

---

## Prompt Templates

### Single Session Prompt

```markdown
## Instructions for AI

You are an expert in MCP server/tool optimization.
You will receive telemetry from a single Token Audit session.

Your goals:
1. Identify inefficient or risky MCP tools.
2. Explain potential causes of heavy token usage or repetition.
3. Recommend structural improvements:
   - tool input/output design
   - prompt structure/verbosity
   - batching or caching opportunities
4. Keep your recommendations practical and actionable.

Do NOT guess about missing data. Base all conclusions on telemetry only.

## Session Telemetry

```json
{SUMMARY_JSON_HERE}
```
```

### Multi-Session Comparison Prompt

```markdown
## Instructions for AI

You are an expert in MCP performance analysis.
You will receive telemetry for multiple Token Audit sessions.

Your goals:
1. Compare the efficiency of sessions.
2. Identify tools or servers responsible for token inflation.
3. Explain structural differences in usage patterns.
4. Provide recommendations for reducing context bloat or inefficiency.
5. Highlight deltas and anomalies found across sessions.

Do NOT hallucinate about internal architecture; infer only from telemetry.

## Comparison Telemetry

```json
{SUMMARY_JSON_HERE}
```
```

---

## Design Principles

| Principle | Implementation |
|-----------|----------------|
| **Compact** | No verbose field names, no full logs |
| **Self-describing** | `_export` header with type and version |
| **Hierarchical** | Server -> Tool structure mirrors mental model |
| **Smell-aware** | Smells at both tool level and top level |
| **Quality-aware** | `data_quality` indicates estimation confidence |
| **Delta-focused** | Comparison includes pre-computed deltas |
| **AI-optimized** | Structured for LLM consumption |

---

## Export Destinations

| Destination | Method |
|-------------|--------|
| stdout | Default (for piping) |
| Clipboard | TUI `[A]` copies to clipboard |
| File | `--out <filename>` flag |

---

## Versioning

The export schema is versioned independently from the session schema:

| Export Version | Session Schema | Notes |
|----------------|----------------|-------|
| 1.0.0 | 1.5.0+ | Initial release with smells |

Older sessions can still be exported - missing fields use defaults.

---

## Related Documentation

- [v1 Session Schema](v1-session-schema.md) - Full session log format
- [Data Contract](data-contract.md) - Backward compatibility guarantees
- [AI Prompt Export Spec](ideas/token-audit-ai-prompt-export-spec.md) - Original specification
